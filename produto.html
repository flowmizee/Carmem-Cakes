<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Produto - Cakes</title>
  <link rel="icon" type="image/png" href="divas.png">
  <style>
    /* (Seu CSS original — preservado) */
    html, body { margin: 0; padding: 0; height: 100%; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #fff; display: flex; flex-direction: column; min-height: 100vh; }
    .nav-wrapper { position: fixed; top: 0; left: 0; right: 0; background: #fff; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; }
    .menu-icon { font-size: 28px; cursor: pointer; position: relative; }
    .bag-icon { width: 56px; height: 56px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; }
    .bag-icon img { width: 100%; height: auto; }
    .bag-icon .cart-count { position: absolute; top: -4px; right: -8px; background: #ff0000; color: #fff; font-size: 12px; padding: 2px 6px; border-radius: 12px; display: none; }
    .logo img { max-height: 80px; width: auto; cursor: pointer; }
    .search-container { display: flex; width: 100%; padding: 0 16px 16px; }
    .search-input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px 0 0 8px; outline: none; font-size: 16px; background-color: #f2f2f2; }
    .search-button { background-color: #dfb33a; border: none; padding: 0 16px; border-radius: 0 8px 8px 0; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .search-button img { height: 36px; width: auto; }
    .categories-container { display: flex; gap: 16px; overflow-x: auto; scroll-behavior: smooth; padding: 8px 16px 16px; -webkit-overflow-scrolling: touch; }
    .categories-container.hidden { scrollbar-width: none; }
    .categories-container.hidden::-webkit-scrollbar { display: none; }
    .categories-container::-webkit-scrollbar { height: 6px; transition: all 0.3s ease; }
    .categories-container.hidden::-webkit-scrollbar-thumb { background-color: transparent; }
    .categories-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .categories-container::-webkit-scrollbar-thumb { background: #dfb33a; border-radius: 3px; transition: all 0.3s ease; }
    .category { cursor: pointer; white-space: nowrap; padding: 12px 0; font-size: 18px; font-weight: 500; text-transform: uppercase; color: #333; transition: all 0.2s; }
    .category:hover { color: #dfb33a; }
    .main-content { margin-top: 260px; flex: 1; display: flex; flex-direction: column; }
    .produto-container { padding: 16px; min-height: 300px; }
    .produtos-wrapper { display: none; padding: 16px; background-color: #f2f2f2; flex: 1; }
    #breadcrumb { display: none; background: #fff; border-bottom: 1px solid #eee; padding: 8px 16px; }
    #breadcrumb .path { font-size: 14px; color: #007bff; cursor: pointer; text-decoration: underline; }
    #breadcrumb .separator { font-size: 14px; color: #555; margin: 0 8px; }
    #breadcrumb .crumbName { font-size: 14px; text-transform: capitalize; }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
    .header-row .title { font-weight: bold; font-size: 20px; text-transform: uppercase; }
    .header-row .count { font-size: 14px; color: #555; }
    .breadcrumb-list { font-size: 14px; color: #666; margin-bottom: 16px; }
    .breadcrumb-list a { color: #007bff; text-decoration: none; }
    .carousel { position: relative; margin-bottom: 16px; }
    .carousel img { width: 100%; height: 350px; object-fit: cover; border-radius: 8px; }
    .produto-nome { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px; }
    .produto-preco { font-size: 24px; font-weight: bold; color: #000; margin-bottom: 8px; }
    .produto-extra { font-size: 15px; color: #007bff; margin-bottom: 16px; }
    .purchase-controls { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    .qty-controls { display: flex; align-items: center; border: 1px solid #ccc; border-radius: 8px; }
    .qty-controls button { background: none; border: none; font-size: 18px; padding: 8px 12px; cursor: pointer; }
    .qty-controls .qty { padding: 0 12px; font-size: 18px; min-width: 24px; text-align: center; }
    .buy-btn { flex: 1; background-color: #dfb33a; color: #fff; border: none; padding: 12px; border-radius: 8px; font-size: 16px; cursor: pointer; }
    .info-section { font-size: 14px; color: #555; margin-bottom: 4px; }
    .descricao { font-size: 14px; color: #333; margin-top: 8px; line-height: 1.5; }
    hr { border: none; border-top: 1px solid #ddd; margin: 16px 0; }
    .produtos-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
    .produto { cursor: pointer; }
    .produto img { width: 100%; height: 240px; object-fit: cover; border-radius: 8px; margin-bottom: 12px; }
    .produto .nome { font-size: 14px; font-weight: bold; margin-bottom: 8px; }
    .produto .preco { font-size: 20px; font-weight: bold; margin-bottom: 8px; }
    .produto .extra { font-size: 13px; color: #007bff; margin-bottom: 8px; }
    .no-products { grid-column: 1 / -1; text-align: center; padding: 20px; }
    .category-section { margin-bottom: 32px; }
    .category-title { font-size: 24px; font-weight: bold; margin: 24px 0 16px; text-transform: uppercase; cursor: pointer; }
    #overlayMenu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; transform: translateX(-100%); transition: transform 0.3s ease; z-index: 2000; padding: 60px 20px; display: flex; flex-direction: column; }
    #overlayMenu.open { transform: translateX(0); }
    #overlayMenu .close-btn { position: absolute; top: 16px; right: 16px; font-size: 32px; cursor: pointer; }
    #overlayMenu nav { display: flex; flex-direction: column; gap: 0; margin-top: 20px; }
    #overlayMenu nav a { font-size: 20px; color: #000; text-decoration: none; text-transform: uppercase; padding: 8px 0; }
    .site-footer { background-color: #dfb33a; color: #fff; padding: 16px; margin-top: auto; }
    .site-footer .footer-item { margin-bottom: 12px; font-size: 14px; }
    .site-footer .footer-item.instagram { margin-bottom: 32px; }
    .site-footer .footer-item.instagram img { width: 20px; height: auto; display: block; }
    .site-footer .footer-item a { color: inherit; text-decoration: none; }
    .site-footer .footer-item:last-child { margin-bottom: 0; }
    @media (max-width: 480px) {
      .main-content { margin-top: 240px; }
      .carousel img { height: 280px; }
      .category { font-size: 16px; padding: 10px 0; }
      .categories-container { gap: 16px; padding: 8px 16px 16px; }
      .produtos-grid { grid-template-columns: 1fr 1fr; }
      .produto img { height: 220px; }
    }

    /* flying image */
    .flying-image {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      will-change: transform, opacity;
      transition: transform 700ms cubic-bezier(.2,.8,.2,1), opacity 700ms ease;
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }
    /* skeleton (quick) */
    .skeleton { width: 100%; display: grid; gap: 12px; }
    .skeleton .s-img { width: 100%; height: 350px; background: linear-gradient(90deg, #eee, #f5f5f5, #eee); background-size: 200% 100%; animation: shine 1.2s infinite; border-radius: 8px; }
    .skeleton .s-line { height: 18px; background: linear-gradient(90deg, #eee, #f5f5f5, #eee); background-size: 200% 100%; animation: shine 1.2s infinite; border-radius: 6px; }
    @keyframes shine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>

  <!-- PapaParse CDN (adicionado) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div id="overlayMenu">
    <div class="close-btn">&times;</div>
    <nav>
      <a href="index.html" id="home-link">Início</a>
      <a href="#" id="all-products-link">Produtos</a>
      <a href="contato.html">Contato</a>
    </nav>
  </div>

  <div class="nav-wrapper">
    <header class="header">
      <div class="menu-icon">&#9776;</div>
      <a href="index.html" class="logo">
        <img src="logo.webp" alt="Logo">
      </a>
      <a href="carrinho.html" class="bag-icon" id="cart-icon">
        <img src="cart.webp" alt="Carrinho de compras">
        <span class="cart-count" id="cart-count">0</span>
      </a>
    </header>
    <div class="search-container">
      <input class="search-input" type="text" placeholder="O que você está procurando?">
      <button class="search-button"><img src="lupa.webp" alt="Buscar"></button>
    </div>
    <div id="cats" class="categories-container">
      <div class="category">MORANGO DO AMOR</div>
      <div class="category">BOLOS</div>
      <div class="category">SALGADOS</div>
      <div class="category">DOCES</div>
    </div>
  </div>

  <div class="main-content">
    <div id="breadcrumb">
      <span class="path">Início</span>
      <span class="separator">&gt;</span>
      <span class="crumbName"></span>
      <div class="header-row">
        <span class="title"></span>
        <span class="count"></span>
      </div>
    </div>

    <div class="produto-container" id="produto"></div>

    <div id="produtos-wrapper" class="produtos-wrapper"></div>
  </div>

  <footer class="site-footer">
    <div class="footer-item instagram">
      <a href="https://www.instagram.com/carmem_mcakes/" target="_blank" rel="noopener">
        <img src="instagramicon.png" alt="Instagram">
      </a>
    </div>
    <div class="footer-item">
      <a href="https://wa.me/5598982066609" target="_blank" rel="noopener">5598982066609</a>
    </div>
    <div class="footer-item">
      <a href="tel:+5598982066609">98982066609</a>
    </div>
    <div class="footer-item copyright">© Flowmize – 2025. Todos os direitos reservados.</div>
  </footer>

  <script>
    /* ============================
       CONFIG
       ============================ */
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpRIMaL2mtK3AyrckDd8DI9cZIWZX17I8bB-oUidxXWa60sD7S1HvHE-9cpPUTFJVSpPY7d7CSIzpc/pub?output=csv';
    const CART_KEY = 'cartItems';

    /* ============================
       Cart helpers
       ============================ */
    function getCartItems() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; }
    }
    function setCartItems(items) {
      try { localStorage.setItem(CART_KEY, JSON.stringify(items)); } catch {}
      renderCartCount();
    }
    function renderCartCount() {
      const cartCountEl = document.getElementById('cart-count');
      const totalQty = getCartItems().reduce((sum, item) => sum + (parseInt(item.quantidade || 0, 10) || 0), 0);
      cartCountEl.textContent = totalQty;
      cartCountEl.style.display = totalQty > 0 ? 'inline-block' : 'none';
    }
    document.addEventListener('DOMContentLoaded', renderCartCount);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) renderCartCount(); });

    /* ============================
       Flying animation (copiado do seu outro código)
       ============================ */
    function flyImageToCart(sourceImg) {
      return new Promise((resolve) => {
        try {
          const rect = sourceImg.getBoundingClientRect();
          const clone = sourceImg.cloneNode(true);
          clone.className = 'flying-image';
          clone.style.width = rect.width + 'px';
          clone.style.height = rect.height + 'px';
          clone.style.left = rect.left + 'px';
          clone.style.top = rect.top + 'px';
          clone.style.opacity = '1';
          document.body.appendChild(clone);
          const cartIcon = document.getElementById('cart-icon');
          const cartRect = cartIcon.getBoundingClientRect();
          const targetX = cartRect.left + (cartRect.width/2) - (rect.left + rect.width/2);
          const targetY = cartRect.top + (cartRect.height/2) - (rect.top + rect.height/2);
          const scale = 0.18;
          requestAnimationFrame(()=> {
            clone.style.transform = `translate(${targetX}px, ${targetY}px) scale(${scale})`;
            clone.style.opacity = '0.2';
          });
          clone.addEventListener('transitionend', function handler() {
            clone.removeEventListener('transitionend', handler);
            clone.remove();
            resolve();
          });
          setTimeout(()=>{ if(document.body.contains(clone)){ clone.remove(); resolve(); } }, 1200);
        } catch(e) { console.warn('fly failed', e); resolve(); }
      });
    }

    function addToCartAndPersist(item) {
      const items = getCartItems();
      const exists = items.find(i => i.nome === item.nome && (i.opcao || '') === (item.opcao || ''));
      if (exists) exists.quantidade = (parseInt(exists.quantidade||0,10)||0) + (parseInt(item.quantidade||0,10)||0);
      else { item.quantidade = parseInt(item.quantidade||0,10)||0; items.push(item); }
      setCartItems(items);
    }

    /* ============================
       CSV parsing + quick product render
       ============================ */
    let allProdutos = [];
    let categorizedProducts = {};
    let catalogLoaded = false;

    function normalizeText(text) {
      if (!text) return '';
      try { return text.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }
      catch { return String(text).toLowerCase().trim(); }
    }

    const categoryMap = {
      'MORANGO DO AMOR': ['morango', 'morango do amor', 'morangos'],
      'BOLOS': ['bolo', 'bolos', 'torta', 'tortas'],
      'SALGADOS': ['salgado', 'salgados', 'salgadinho', 'salgadinhos'],
      'DOCES': ['doce', 'doces', 'sobremesa', 'sobremesas']
    };

    function containsAnyTerm(text, terms) {
      const normalizedText = normalizeText(text);
      return terms.some(term => normalizedText.includes(term));
    }

    function categorizeProducts() {
      categorizedProducts = {
        'MORANGO DO AMOR': [],
        'BOLOS': [],
        'SALGADOS': [],
        'DOCES': []
      };
      allProdutos.forEach(product => {
        for (const [category, terms] of Object.entries(categoryMap)) {
          if (containsAnyTerm(product.nome, terms)) {
            categorizedProducts[category].push(product);
            break;
          }
        }
      });
      for (const category in categorizedProducts) {
        if (categorizedProducts[category].length === 0) delete categorizedProducts[category];
      }
    }

    function showSkeleton() {
      const container = document.getElementById('produto');
      container.style.display = '';
      container.innerHTML = `
        <div class="skeleton">
          <div class="s-img"></div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div class="s-line" style="width:70%"></div>
            <div class="s-line" style="width:40%"></div>
            <div class="s-line" style="width:30%"></div>
            <div class="s-line" style="width:100%;height:80px"></div>
          </div>
        </div>
      `;
    }

    // Rapid streaming parse to locate a product and render it immediately
    function parseAndShowProductFast(productName) {
      return new Promise((resolve) => {
        let rowIndex = -1;
        let found = false;
        showSkeleton();

        Papa.parse(CSV_URL, {
          download: true,
          skipEmptyLines: true,
          step: function(results, parser) {
            rowIndex++;
            const row = results.data;
            if (rowIndex === 0) return; // skip header
            if (!row || !row[2]) return;
            const nomeCell = (row[2]||'').toString().trim();
            if (nomeCell && normalizeText(nomeCell) === normalizeText(productName)) {
              found = true;
              const c = row;
              const produtoObj = {
                nome: c[2]?.toString().trim() || '',
                imagem: (c[3] || '').toString().trim() || '',
                descricao: (c[4] || '').toString().trim() || '',
                preco: (c[5] || '').toString().trim() || '',
                mensagem: (c[6] || '').toString().trim() || '',
                estoque: (c[7] || '').toString().trim() || ''
              };
              showProduto(produtoObj);
              parser.abort();
              resolve(true);
            }
          },
          error: function(err) {
            console.error('Parse fast error', err);
            resolve(false);
          },
          complete: function() {
            if (!found) {
              // fallback: try to render from URL params (if provided)
              const params = new URLSearchParams(window.location.search);
              const img = params.get('imagem') ? decodeURIComponent(params.get('imagem')) : '';
              const descricao = params.get('descricao') ? decodeURIComponent(params.get('descricao')) : '';
              const preco = params.get('preco') ? decodeURIComponent(params.get('preco')) : '';
              const mensagem = params.get('mensagem') ? decodeURIComponent(params.get('mensagem')) : '';
              const productFromParams = { nome: productName, imagem: img, descricao, preco, mensagem };
              showProduto(productFromParams);
              resolve(false);
            }
          }
        });
      });
    }

    // Full parse in background to populate allProdutos (used for lists & search)
    function parseAllProductsBackground() {
      return new Promise((resolve) => {
        Papa.parse(CSV_URL, {
          download: true,
          skipEmptyLines: true,
          complete: function(results) {
            const rows = results.data || [];
            const lines = rows.slice(1); // remove header
            allProdutos = [];
            lines.forEach(cells => {
              if (!cells || !cells[2] || !cells[3]) return;
              // skip if estoque == '0'
              const estoque = (cells[7] || '').toString().trim();
              if (estoque === '0') return;
              allProdutos.push({
                nome: (cells[2] || '').toString().trim(),
                imagem: (cells[3] || '').toString().trim(),
                descricao: (cells[4] || '').toString().trim() || '',
                preco: (cells[5] || '').toString().trim() || '',
                mensagem: (cells[6] || '').toString().trim() || '',
                estoque
              });
            });
            categorizeProducts();
            catalogLoaded = true;
            resolve(allProdutos);
          },
          error: function(err) {
            console.error('Parse completo error', err);
            catalogLoaded = true;
            resolve([]);
          }
        });
      });
    }

    /* ============================
       UI rendering functions
       ============================ */
    const produtoContainer = document.getElementById('produto');
    const produtosWrapper = document.getElementById('produtos-wrapper');
    const breadcrumbEl = document.getElementById('breadcrumb');
    const pathEl = breadcrumbEl.querySelector('.path');
    const crumbNameEl = breadcrumbEl.querySelector('.crumbName');
    const headerTitleEl = breadcrumbEl.querySelector('.header-row .title');
    const headerCountEl = breadcrumbEl.querySelector('.header-row .count');

    function showProduto(product) {
      if (!product) return;
      window.scrollTo({ top: 0, behavior: 'smooth' });
      produtoContainer.style.display = 'block';
      produtosWrapper.style.display = 'none';

      // prepare data
      const desc = product.descricao || '';
      let preco = (product.preco || '').toString().trim();
      preco = preco.replace(/[^\d.,]/g,'');
      if (preco && !preco.includes(',')) {
        if (preco.indexOf('.') !== -1) preco = preco.replace('.',','); else preco = preco + ',00';
      }
      const extra = product.mensagem || '';

      // Update breadcrumb
      pathEl.textContent = 'Início';
      crumbNameEl.textContent = product.nome || '';
      headerTitleEl.textContent = (product.nome || '').toUpperCase();
      headerCountEl.textContent = '';

      // Render HTML (note: carousel img has id="carousel-image" for flying)
      produtoContainer.innerHTML = `
        <div class="carousel">
          <img id="carousel-image" src="${product.imagem || ''}" alt="${product.nome || ''}">
        </div>
        <div class="produto-nome">${product.nome || ''}</div>
        <div class="produto-preco">R$ ${preco || ''}</div>
        ${extra ? `<div class="produto-extra">${extra}</div>` : ''}
        <div class="purchase-controls">
          <div class="qty-controls">
            <button id="decrease">-</button>
            <div class="qty" id="quantity">1</div>
            <button id="increase">+</button>
          </div>
          <button class="buy-btn" id="buy-btn">COMPRAR</button>
        </div>
        <strong>Compra protegida</strong>
        <div class="info-section">Seus dados cuidados durante toda a compra.</div><hr>
        <strong>Qualidade e cuidado</strong>
        <div class="info-section">Cuidamos do seu pedido como se fosse nosso.</div><hr>
        ${desc ? `<strong>Descrição</strong><div class="descricao">${desc}</div>` : ''}
      `;

      // quantity controls
      let qty = 1;
      document.getElementById('decrease').onclick = () => { if (qty > 1) qty--; document.getElementById('quantity').textContent = qty; };
      document.getElementById('increase').onclick = () => { qty++; document.getElementById('quantity').textContent = qty; };

      // buy button -> animate then persist
      document.getElementById('buy-btn').onclick = async () => {
        const sourceImg = document.getElementById('carousel-image');
        const nome = product.nome || '';
        const precoText = preco || '';
        const quantidade = parseInt(document.getElementById('quantity').textContent, 10) || 1;

        if (sourceImg && sourceImg.src) {
          await flyImageToCart(sourceImg);
        }
        // After animation, persist in cart
        addToCartAndPersist({ nome, preco: precoText, quantidade, imagem: product.imagem || '' });
      };
    }

    function renderProdutos(list) {
      produtoContainer.style.display = 'none';
      produtosWrapper.style.display = 'block';

      const validProducts = (list || []).filter(p => p && p.nome && p.imagem);
      if (validProducts.length === 0) {
        produtosWrapper.innerHTML = '<div class="no-products">Nenhum produto encontrado</div>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'produtos-grid';

      validProducts.forEach(p => {
        const div = document.createElement('div');
        div.className = 'produto';
        div.addEventListener('click', () => {
          const params = new URLSearchParams();
          params.set('produto', p.nome);
          params.set('imagem', encodeURIComponent(p.imagem));
          params.set('descricao', p.descricao || '');
          params.set('preco', p.preco || '');
          params.set('mensagem', p.mensagem || '');
          location.href = `produto.html?${params.toString()}`;
        });
        div.innerHTML = `
          <img src="${p.imagem}" alt="${p.nome}">
          <div class="nome">${p.nome}</div>
          <div class="preco">${p.preco || ''}</div>
          ${p.mensagem ? `<div class="extra">${p.mensagem}</div>` : ''}
        `;
        grid.appendChild(div);
      });

      produtosWrapper.innerHTML = '';
      produtosWrapper.appendChild(grid);
    }

    function renderCategorizedProducts() {
      produtosWrapper.innerHTML = '';
      produtoContainer.style.display = 'none';
      produtosWrapper.style.display = 'block';
      breadcrumbEl.style.display = 'none';

      for (const [category, products] of Object.entries(categorizedProducts)) {
        if (!products || products.length === 0) continue;
        const categorySection = document.createElement('div'); categorySection.className = 'category-section';
        const title = document.createElement('div'); title.className = 'category-title'; title.textContent = category;
        title.addEventListener('click', () => { renderProdutos(products); showBreadcrumb(category, products); });
        const grid = document.createElement('div'); grid.className = 'produtos-grid';
        const productsToShow = products.slice(0,4);
        productsToShow.forEach(p => {
          const div = document.createElement('div'); div.className = 'produto';
          div.addEventListener('click', () => {
            const params = new URLSearchParams();
            params.set('produto', p.nome);
            params.set('imagem', encodeURIComponent(p.imagem));
            params.set('descricao', p.descricao || '');
            params.set('preco', p.preco || '');
            params.set('mensagem', p.mensagem || '');
            location.href = `produto.html?${params.toString()}`;
          });
          div.innerHTML = `<img src="${p.imagem}" alt="${p.nome}"><div class="nome">${p.nome}</div><div class="preco">${p.preco || ''}</div>${p.mensagem ? `<div class="extra">${p.mensagem}</div>` : ''}`;
          grid.appendChild(div);
        });
        categorySection.appendChild(title); categorySection.appendChild(grid);
        produtosWrapper.appendChild(categorySection);
      }
    }

    function showBreadcrumb(name, list, isSingle=false) {
      pathEl.textContent = 'Início';
      crumbNameEl.textContent = name;
      headerTitleEl.textContent = (name || '').toUpperCase();
      if (isSingle) headerCountEl.textContent = '';
      else {
        const validProducts = (list || []).filter(p => p && p.nome && p.imagem);
        headerCountEl.textContent = `${validProducts.length} produto${validProducts.length !== 1 ? 's' : ''}`;
      }
      breadcrumbEl.style.display = 'block';
    }

    function resetToHomePage() {
      breadcrumbEl.style.display = 'none';
      produtoContainer.style.display = 'none';
      produtosWrapper.style.display = 'block';
      renderCategorizedProducts();
    }

    /* ============================
       Initialization
       ============================ */
    (async function init(){
      // UI handlers minimal
      document.querySelector('.menu-icon').addEventListener('click', ()=> document.getElementById('overlayMenu').classList.add('open'));
      document.querySelector('#overlayMenu .close-btn').addEventListener('click', ()=> document.getElementById('overlayMenu').classList.remove('open'));
      document.getElementById('home-link').addEventListener('click', function(e){ e.preventDefault(); window.location.href='index.html'; });
      document.querySelector('.logo img').addEventListener('click', ()=> window.location.href='index.html');
      pathEl.addEventListener('click', ()=> window.location.href='index.html');

      document.querySelectorAll('.category').forEach(el => {
        el.addEventListener('click', () => {
          const name = el.textContent.trim();
          const filtered = allProdutos.filter(p => containsAnyTerm(p.nome || '', categoryMap[name] || [normalizeText(name)]));
          renderProdutos(filtered);
          showBreadcrumb(name, filtered);
        });
      });

      // search
      const si = document.querySelector('.search-input');
      const sb = document.querySelector('.search-button');
      si.addEventListener('input', () => {
        const t = si.value.trim();
        if (!t) { resetToHomePage(); return; }
        const filtered = allProdutos.filter(p => normalizeText(p.nome || '').includes(normalizeText(t)));
        renderProdutos(filtered);
        showBreadcrumb(t, filtered);
      });
      sb.addEventListener('click', ()=> si.dispatchEvent(new Event('input')));

      // all products link
      document.getElementById('all-products-link').addEventListener('click', (e) => {
        e.preventDefault();
        renderProdutos(allProdutos);
        showBreadcrumb('Todos os Produtos', allProdutos);
        document.getElementById('overlayMenu').classList.remove('open');
      });

      // Determine URL param
      const params = new URLSearchParams(window.location.search);
      const nomeProduto = params.get('produto') ? decodeURIComponent(params.get('produto')) : '';

      if (nomeProduto) {
        // If product param exists, show it quickly via streaming parse
        await parseAndShowProductFast(nomeProduto);
        // still load the full catalog in background (to enable search/list)
        parseAllProductsBackground().then(()=>{}).catch(()=>{});
        return;
      }

      // No product param -> load full catalog and render categories
      try {
        const data = await parseAllProductsBackground();
        allProdutos = data || allProdutos;
        renderCategorizedProducts();
      } catch (err) {
        console.error('Erro no carregamento inicial do CSV', err);
        produtosWrapper.innerHTML = '<div class="no-products">Erro ao carregar o catálogo</div>';
        produtosWrapper.style.display = 'block';
      }
    })();

    /* ============================
       Other event handlers
       ============================ */
    document.getElementById('all-products-link').addEventListener('click', function(e){ e.preventDefault(); document.getElementById('overlayMenu').classList.remove('open'); });

    // Clicking a product card navigates to ?produto=..., handled above (fast parse)
  </script>
</body>
</html>
