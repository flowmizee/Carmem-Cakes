<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedidos Recebidos</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
    }
    
    body {
      background-color: #e5ddd5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background-color: #008069;
      color: white;
      padding: 60px 16px 12px 16px;
      display: flex;
      align-items: center;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 100;
    }
    
    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
    }
    
    .header-info {
      flex: 1;
    }
    
    .header-title {
      font-size: 18px;
      font-weight: 500;
    }
    
    .messages-container {
      flex: 1;
      padding: 80px 0 20px 0;
      overflow-y: auto;
      background-image: url('https://web.whatsapp.com/img/bg-chat-tile-light_a4be512e7195b6b733d9110b408f075d.png');
      background-repeat: repeat;
    }
    
    .date-separator {
      text-align: center;
      margin: 16px 0;
      position: relative;
    }
    
    .date-separator span {
      background-color: #e5ddd5;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #333;
      position: relative;
      z-index: 1;
    }
    
    .date-separator::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background-color: #ccc;
      z-index: 0;
    }
    
    .message {
      margin: 6px 16px;
      display: flex;
      justify-content: flex-start;
    }
    
    .message-content {
      background-color: white;
      border-radius: 8px;
      padding: 8px 12px;
      max-width: 80%;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }
    
    .message-text {
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-line;
      font-family: monospace;
    }
    
    .print-btn {
      display: inline-block;
      margin-top: 8px;
      padding: 4px 8px;
      background-color: #008069;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="logo.webp" alt="Profile" class="profile-pic">
    <div class="header-info">
      <div class="header-title">Pedidos Recebidos</div>
    </div>
  </div>
  
  <div class="messages-container" id="messages-container">
    <div class="loading">Carregando pedidos...</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const API_URL = "https://opensheet.elk.sh/1_KqTCa8u1G49hRs3Vzf-SfU_uGLSYXlK1sAJHMqR_Ic/Pedidos";
      const messagesContainer = document.getElementById('messages-container');
      
      // Formata a data para o padr√£o brasileiro
      function formatDate(dateStr) {
        if (!dateStr) return '';
        
        try {
          const date = new Date(dateStr);
          if (isNaN(date.getTime())) return dateStr;
          
          const options = { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' };
          let formatted = date.toLocaleDateString('pt-BR', options);
          
          // Capitaliza o dia da semana
          formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
          
          return formatted.replace(',', ' -');
        } catch (e) {
          return dateStr;
        }
      }
      
      // Formata o hor√°rio
      function formatTime(dateStr) {
        if (!dateStr) return '';
        
        try {
          const date = new Date(dateStr);
          if (isNaN(date.getTime())) return dateStr;
          
          return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        } catch (e) {
          return dateStr;
        }
      }
      
      // Formata o pre√ßo
      function formatPrice(price) {
        if (!price) return 'R$ 0,00';
        return 'R$ ' + parseFloat(price).toFixed(2).replace('.', ',');
      }
      
      // Formata o n√∫mero de telefone
      function formatPhone(phone) {
        if (!phone) return '';
        phone = phone.toString().replace(/\D/g, '');
        
        if (phone.length === 11) {
          return `(${phone.substring(0, 2)}) ${phone.substring(2, 7)}-${phone.substring(7)}`;
        } else if (phone.length === 10) {
          return `(${phone.substring(0, 2)}) ${phone.substring(2, 6)}-${phone.substring(6)}`;
        }
        return phone;
      }
      
      // Cria o texto do pedido no formato do comprovante WhatsApp
      function createOrderMessage(order) {
        // Calcula o total considerando a taxa de entrega se aplic√°vel
        const total = order['Entrega/Retirada'] === 'Entrega' ? 
          (parseFloat(order['Pre√ßo Total']) + 3).toFixed(2) : 
          order['Pre√ßo Total'];
        
        let message = `================================\n`;
        message += `         COMPROVANTE DE PEDIDO\n`;
        message += `================================\n\n`;
        
        message += `Nome: ${order['Nome do Cliente'] || ''}\n`;
        message += `WhatsApp: ${formatPhone(order['N√∫mero do Cliente'])}\n`;
        message += `Tipo de Entrega: ${order['Entrega/Retirada'] === 'Entrega' ? 'ENTREGA' : 'RETIRADA'}\n\n`;

        if (order['Entrega/Retirada'] === 'Entrega') {
          message += `Cidade: ${order.Cidade || ''}\n`;
          message += `Ponto de Refer√™ncia: ${order['Ponto de Refer√™ncia'] || ''}\n`;
          if (order.Complemento) {
            message += `Complemento: ${order.Complemento}\n`;
          }
          message += `Taxa de entrega: R$ 3,00\n\n`;
        }

        message += `-----------------------------------------------------\n`;
        message += `Forma de Pagamento: ${order['Forma de Pagamento'] || ''}\n`;
        if (order['Forma de Pagamento'] === 'Pix') {
          message += `Chave Pix: 98982066609\n`;
        }
        message += `-----------------------------------------------------\n\n`;

        message += `Itens do Pedido:\n`;
        // Simulando os itens (ajuste conforme sua estrutura real de dados)
        const items = order.Produtos ? order.Produtos.split(',') : [];
        items.forEach(item => {
          message += `‚û§ ${item.trim()}\n`;
        });
        message += `\n`;

        message += `-----------------------------------------------------\n`;
        message += `TOTAL DO PEDIDO: ${formatPrice(total)}\n`;
        message += `-----------------------------------------------------\n\n`;
        
        message += `Data/Hora: ${formatDate(order['Data/Hora'])} ${formatTime(order['Data/Hora'])}\n\n`;
        message += `OBS: O pedido s√≥ ser√° reservado ap√≥s a confirma√ß√£o do pagamento.`;

        return message;
      }

      // Agrupa pedidos por data
      function groupOrdersByDate(orders) {
        const grouped = {};
        
        orders.forEach(order => {
          const dateStr = order['Data/Hora'];
          if (!dateStr) return;
          
          const date = new Date(dateStr);
          if (isNaN(date.getTime())) return;
          
          // Usa apenas a data (ignora horas) para agrupamento
          const dateKey = date.toISOString().split('T')[0];
          
          if (!grouped[dateKey]) {
            grouped[dateKey] = [];
          }
          
          grouped[dateKey].push(order);
        });
        
        return grouped;
      }
      
      // Renderiza os pedidos agrupados por data
      function renderOrders(groupedOrders) {
        messagesContainer.innerHTML = '';
        
        // Ordena as datas do mais recente para o mais antigo
        const sortedDates = Object.keys(groupedOrders).sort((a, b) => new Date(b) - new Date(a));
        
        sortedDates.forEach(dateKey => {
          const orders = groupedOrders[dateKey];
          const firstOrder = orders[0];
          const formattedDate = formatDate(firstOrder['Data/Hora']);
          
          // Adiciona separador de data
          const dateSeparator = document.createElement('div');
          dateSeparator.className = 'date-separator';
          dateSeparator.innerHTML = `<span>${formattedDate}</span>`;
          messagesContainer.appendChild(dateSeparator);
          
          // Adiciona os pedidos dessa data
          orders.forEach(order => {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.textContent = createOrderMessage(order);
            
            const printBtn = document.createElement('div');
            printBtn.className = 'print-btn';
            printBtn.textContent = 'üñ®Ô∏è Imprimir';
            
            messageContent.appendChild(messageText);
            messageContent.appendChild(printBtn);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);
          });
        });
        
        if (sortedDates.length === 0) {
          messagesContainer.innerHTML = '<div class="message"><div class="message-content"><div class="message-text">Nenhum pedido encontrado</div></div></div>';
        }
      }
      
      // Carrega os dados da planilha
      fetch(API_URL)
        .then(response => response.json())
        .then(data => {
          const groupedOrders = groupOrdersByDate(data);
          renderOrders(groupedOrders);
        })
        .catch(error => {
          console.error('Erro ao carregar pedidos:', error);
          messagesContainer.innerHTML = '<div class="message"><div class="message-content"><div class="message-text">Erro ao carregar pedidos. Tente novamente mais tarde.</div></div></div>';
        });
    });
  </script>
</body>
</html>
