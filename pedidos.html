<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedidos Recebidos</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
    }
    
    body {
      background-color: #f5f5f5;
      min-height: 100vh;
    }
    
    .header {
      background-color: #dfb33a;
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
    }
    
    .header-title {
      font-size: 18px;
      font-weight: bold;
      flex-grow: 1;
    }
    
    .date-filter {
      padding: 10px 15px;
      background-color: #fff;
      position: sticky;
      top: 70px;
      z-index: 90;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .date-filter select {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    
    .orders-container {
      padding: 15px;
    }
    
    .date-separator {
      color: #666;
      font-size: 14px;
      margin: 20px 0 10px 0;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    
    .order-card {
      background-color: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .order-header {
      font-weight: bold;
      margin-bottom: 10px;
      color: #dfb33a;
    }
    
    .order-field {
      margin-bottom: 8px;
      display: flex;
    }
    
    .field-label {
      font-weight: bold;
      min-width: 120px;
      color: #555;
    }
    
    .field-value {
      flex-grow: 1;
    }
    
    .items-list {
      margin-top: 10px;
      border-top: 1px dashed #eee;
      padding-top: 10px;
    }
    
    .item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .loading {
      text-align: center;
      padding: 30px;
      color: #666;
    }
    
    .no-orders {
      text-align: center;
      padding: 30px;
      color: #666;
    }
    
    .print-btn {
      display: inline-block;
      margin-top: 15px;
      padding: 8px 15px;
      background-color: #dfb33a;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="logo.webp" alt="Logo" class="profile-pic">
    <div class="header-title">Pedidos Recebidos</div>
  </div>
  
  <div class="date-filter">
    <select id="date-select">
      <option value="all">Todos os pedidos</option>
      <!-- As op√ß√µes de data ser√£o preenchidas pelo JavaScript -->
    </select>
  </div>
  
  <div class="orders-container" id="orders-container">
    <div class="loading">Carregando pedidos...</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const API_URL = "https://opensheet.elk.sh/1_KqTCa8u1G49hRs3Vzf-SfU_uGLSYXlK1sAJHMqR_Ic/Pedidos";
      const ordersContainer = document.getElementById('orders-container');
      const dateSelect = document.getElementById('date-select');
      
      // Fun√ß√£o para verificar se um valor existe
      function getValue(value, defaultValue = '-') {
        return value !== undefined && value !== null && value !== '' ? value : defaultValue;
      }

      // Formata a data para exibi√ß√£o
      function formatDisplayDate(dateStr) {
        if (!dateStr) return 'Data n√£o informada';
        
        try {
          const date = new Date(dateStr);
          if (isNaN(date.getTime())) return dateStr;
          
          const options = { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' };
          let formatted = date.toLocaleDateString('pt-BR', options);
          
          return formatted.charAt(0).toUpperCase() + formatted.slice(1).replace(',', ' -');
        } catch (e) {
          return dateStr;
        }
      }
      
      // Formata a data para uso como chave (YYYY-MM-DD)
      function formatDateKey(dateStr) {
        if (!dateStr) return '';
        
        try {
          const date = new Date(dateStr);
          if (isNaN(date.getTime())) return '';
          
          return date.toISOString().split('T')[0];
        } catch (e) {
          return '';
        }
      }
      
      // Formata o hor√°rio
      function formatTime(dateStr) {
        if (!dateStr) return 'Hor√°rio n√£o informado';
        
        try {
          const date = new Date(dateStr);
          if (isNaN(date.getTime())) return dateStr;
          
          return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        } catch (e) {
          return dateStr;
        }
      }
      
      // Formata o pre√ßo
      function formatPrice(price) {
        try {
          const value = parseFloat(price);
          return isNaN(value) ? 'R$ 0,00' : 'R$ ' + value.toFixed(2).replace('.', ',');
        } catch (e) {
          return 'R$ 0,00';
        }
      }
      
      // Formata o n√∫mero de telefone
      function formatPhone(phone) {
        if (!phone) return 'N√£o informado';
        
        try {
          phone = phone.toString().replace(/\D/g, '');
          
          if (phone.length === 11) {
            return `(${phone.substring(0, 2)}) ${phone.substring(2, 7)}-${phone.substring(7)}`;
          } else if (phone.length === 10) {
            return `(${phone.substring(0, 2)}) ${phone.substring(2, 6)}-${phone.substring(6)}`;
          }
          return phone;
        } catch (e) {
          return phone;
        }
      }
      
      // Cria o HTML de um pedido
      function createOrderHTML(order) {
        // Verifica e calcula o total
        let totalValue = 0;
        try {
          totalValue = parseFloat(order['Pre√ßo Total']) || 0;
        } catch (e) {
          totalValue = 0;
        }
        
        const isDelivery = order['Entrega/Retirada'] === 'Entrega';
        const total = isDelivery ? (totalValue + 3).toFixed(2) : totalValue.toFixed(2);
        
        // Processa os itens do pedido
        let items = [];
        try {
          items = order.Produtos ? 
            (Array.isArray(order.Produtos) ? order.Produtos : order.Produtos.split(','))
              .filter(item => item.trim() !== '')
              .map(item => item.trim())
            : ['Itens n√£o especificados'];
        } catch (e) {
          items = ['Itens n√£o especificados'];
        }

        return `
          <div class="order-card">
            <div class="order-header">üëã NOVO PEDIDO</div>
            
            <div class="order-field">
              <div class="field-label">Tipo:</div>
              <div class="field-value">
                ${isDelivery ? 'üöö ENTREGA' : 'üõçÔ∏è RETIRADA NO LOCAL'}
              </div>
            </div>
            
            <div class="order-field">
              <div class="field-label">Nome:</div>
              <div class="field-value">${getValue(order['Nome do Cliente'])}</div>
            </div>
            
            <div class="order-field">
              <div class="field-label">WhatsApp:</div>
              <div class="field-value">${formatPhone(getValue(order['N√∫mero do Cliente']))}</div>
            </div>
            
            ${isDelivery ? `
              <div class="order-field">
                <div class="field-label">Endere√ßo:</div>
                <div class="field-value">
                  ${getValue(order.Cidade)}, ${getValue(order['Ponto de Refer√™ncia'])}
                </div>
              </div>
              
              ${order.Complemento ? `
                <div class="order-field">
                  <div class="field-label">Complemento:</div>
                  <div class="field-value">${getValue(order.Complemento)}</div>
                </div>
              ` : ''}
              
              <div class="order-field">
                <div class="field-label">Taxa de entrega:</div>
                <div class="field-value">R$ 3,00</div>
              </div>
            ` : ''}
            
            <div class="order-field">
              <div class="field-label">Pagamento:</div>
              <div class="field-value">${getValue(order['Forma de Pagamento'])}</div>
            </div>
            
            ${order['Forma de Pagamento'] === 'Pix' ? `
              <div class="order-field">
                <div class="field-label">Chave Pix:</div>
                <div class="field-value">98982066609</div>
              </div>
            ` : ''}
            
            <div class="items-list">
              <div class="order-field" style="margin-bottom: 10px;">
                <div class="field-label">Itens:</div>
                <div class="field-value"></div>
              </div>
              
              ${items.map(item => `
                <div class="item">
                  <span>${item}</span>
                </div>
              `).join('')}
            </div>
            
            <div class="order-field" style="margin-top: 10px; font-weight: bold;">
              <div class="field-label">Total:</div>
              <div class="field-value">${formatPrice(total)}</div>
            </div>
            
            <div class="order-field">
              <div class="field-label">Data/Hora:</div>
              <div class="field-value">${formatTime(order['Data/Hora'])}</div>
            </div>
            
            <button class="print-btn">üñ®Ô∏è Imprimir</button>
          </div>
        `;
      }
      
      // Renderiza todos os pedidos
      function renderOrders(orders, selectedDate = 'all') {
        if (!orders || orders.length === 0) {
          ordersContainer.innerHTML = '<div class="no-orders">Nenhum pedido encontrado</div>';
          return;
        }
        
        // Agrupa pedidos por data
        const ordersByDate = {};
        const uniqueDates = new Set();
        
        orders.forEach(order => {
          const dateKey = formatDateKey(order['Data/Hora']);
          if (!dateKey) return;
          
          uniqueDates.add(dateKey);
          
          if (!ordersByDate[dateKey]) {
            ordersByDate[dateKey] = [];
          }
          
          ordersByDate[dateKey].push(order);
        });
        
        // Ordena as datas do mais recente para o mais antigo
        const sortedDates = Array.from(uniqueDates).sort((a, b) => new Date(b) - new Date(a));
        
        // Atualiza o seletor de datas
        updateDateFilter(sortedDates);
        
        // Filtra por data selecionada
        const datesToShow = selectedDate === 'all' 
          ? sortedDates 
          : sortedDates.filter(date => date === selectedDate);
        
        // Renderiza os pedidos
        let html = '';
        
        datesToShow.forEach(dateKey => {
          const displayDate = formatDisplayDate(dateKey);
          html += `<div class="date-separator">${displayDate}</div>`;
          
          ordersByDate[dateKey].forEach(order => {
            html += createOrderHTML(order);
          });
        });
        
        ordersContainer.innerHTML = html || '<div class="no-orders">Nenhum pedido encontrado para esta data</div>';
      }
      
      // Atualiza o seletor de datas
      function updateDateFilter(dates) {
        // Limpa op√ß√µes existentes (mantendo apenas "Todos os pedidos")
        while (dateSelect.options.length > 1) {
          dateSelect.remove(1);
        }
        
        // Adiciona novas op√ß√µes de data
        dates.forEach(date => {
          const option = document.createElement('option');
          option.value = date;
          option.textContent = formatDisplayDate(date);
          dateSelect.appendChild(option);
        });
      }
      
      // Carrega os dados da planilha
      function loadOrders() {
        fetch(API_URL)
          .then(response => {
            if (!response.ok) throw new Error('Erro na rede');
            return response.json();
          })
          .then(data => {
            // Filtra pedidos com data v√°lida e ordena do mais recente para o mais antigo
            const validOrders = data.filter(order => {
              try {
                return order['Data/Hora'] && !isNaN(new Date(order['Data/Hora']).getTime());
              } catch (e) {
                return false;
              }
            }).sort((a, b) => new Date(b['Data/Hora']) - new Date(a['Data/Hora']));
            
            renderOrders(validOrders);
            
            // Configura o filtro por data
            dateSelect.addEventListener('change', function() {
              renderOrders(validOrders, this.value);
            });
          })
          .catch(error => {
            console.error('Erro ao carregar pedidos:', error);
            ordersContainer.innerHTML = `
              <div class="no-orders">
                Erro ao carregar pedidos. Tente novamente mais tarde.
                <div style="margin-top: 10px; font-size: 12px;">${error.message}</div>
              </div>
            `;
          });
      }
      
      // Inicia o carregamento dos pedidos
      loadOrders();
    });
  </script>
</body>
</html>
